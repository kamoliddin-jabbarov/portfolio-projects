SELECT name 
FROM sys.tables;

-- hamma jadvallarni birlashtirish

SELECT * INTO P2P_2024 FROM [P2P-2024_01(01-10)] WHERE 1 = 0;

INSERT INTO P2P_2024
SELECT * FROM [P2P-2024_01(01-10)]
UNION ALL
SELECT * FROM [P2P-2024_01(11-20)]
UNION ALL
SELECT * FROM [P2P-2024_01(21-31)]
UNION ALL
SELECT * FROM [P2P-2024_02(1-7)]
UNION ALL
SELECT * FROM [P2P-2024_02(8-14)]
UNION ALL
SELECT * FROM [P2P-2024_02(15-22)]
UNION ALL
SELECT * FROM [P2P-2024_02(23-29)]
UNION ALL
SELECT * FROM [P2P-2024_03(1-6)]
UNION ALL
SELECT * FROM [P2P-2024_03(7-14)]
UNION ALL
SELECT * FROM [P2P-2024_03(15-20)]
UNION ALL
SELECT * FROM [P2P-2024_03(21-25)]
UNION ALL
SELECT * FROM [P2P-2024_03(26-31)]
UNION ALL
SELECT * FROM [P2P-2024_04(1-5)]
UNION ALL
SELECT * FROM [P2P-2024_04(6-11)]
UNION ALL
SELECT * FROM [P2P-2024_04(12-17)]
UNION ALL
SELECT * FROM [P2P-2024_04(18-23)]
UNION ALL
SELECT * FROM [P2P-2024_04(24-27)]
UNION ALL
SELECT * FROM [P2P-2024_04(28-30)]
UNION ALL
SELECT * FROM [P2P-2024_05(1-5)]
UNION ALL
SELECT * FROM [P2P-2024_05(6-9)]
UNION ALL
SELECT * FROM [P2P-2024_05(10-14)]
UNION ALL
SELECT * FROM [P2P-2024_05(15-18)]
UNION ALL
SELECT * FROM [P2P-2024_05(19-22)]
UNION ALL
SELECT * FROM [P2P-2024_05(23-27)]
UNION ALL
SELECT * FROM [P2P-2024_05(28-31)]
UNION ALL
SELECT * FROM [P2P-2024_06(1-4)]
UNION ALL
SELECT * FROM [P2P-2024_06(5-8)]
UNION ALL
SELECT * FROM [P2P-2024_06(9-13)]
UNION ALL
SELECT * FROM [P2P-2024_06(14-18)]
UNION ALL
SELECT * FROM [P2P-2024_06(19-23)]
UNION ALL
SELECT * FROM [P2P-2024_06(24-27)]
UNION ALL
SELECT * FROM [P2P-2024_06(28-30)]

SELECT TOP 1 * FROM P2P_2024;

SELECT COLUMN_NAME, DATA_TYPE, CHARACTER_MAXIMUM_LENGTH  
FROM INFORMATION_SCHEMA.COLUMNS  
WHERE TABLE_NAME = 'P2P_2024';

-- username ustunlari bir xil bo'lgani uchun o'chirildi
SELECT SUM(IIF(username=[username 1],0,1)) FROM P2P_2024;

ALTER TABLE P2P_2024
DROP COLUMN [username 1];

-- ustunlarni kerakli formatga o'tkazib olamiz

UPDATE P2P_2024
SET created_at = LEFT(created_at,23)

SELECT created_at  
FROM P2P_2024  
WHERE TRY_CONVERT(DATETIME, created_at) IS NULL;

DELETE FROM P2P_2024
WHERE TRY_CONVERT(DATETIME, created_at) IS NULL;

ALTER TABLE P2P_2024  
ALTER COLUMN created_at DATETIME;

UPDATE P2P_2024
SET updated_at = LEFT(updated_at,23)

SELECT updated_at  
FROM P2P_2024  
WHERE TRY_CONVERT(DATETIME, updated_at) IS NULL;

DELETE FROM P2P_2024
WHERE TRY_CONVERT(DATETIME, updated_at) IS NULL;

ALTER TABLE P2P_2024  
ALTER COLUMN updated_at DATETIME;

ALTER TABLE P2P_2024
ALTER COLUMN username BIGINT;

ALTER TABLE P2P_2024  
ALTER COLUMN debit BIGINT;

ALTER TABLE P2P_2024
ALTER COLUMN credit BIGINT;

ALTER TABLE P2P_2024
ALTER COLUMN commission INT;


-- Ustunlarni nomini ko'rish
SELECT COLUMN_NAME  
FROM INFORMATION_SCHEMA.COLUMNS  
WHERE TABLE_NAME = 'P2P_2024';


-- Keraksiz ustunlar: operation_type, operation_ref, recipient_pan, sender_pan, user_uuid, [username 1], sender_ref, recipient_ref
--Kerakli ustunlarni Viewga olish

DROP VIEW InfoP2P

CREATE VIEW InfoP2P AS
SELECT TOP (14000000) created_at,
	operation_code,
	username,
	debit,
	credit,
	commission,
	recipient_owner,
	recipient_mask,
	recipient_merchant,
	recipient_terminal,
	recipient_service,
	sender_owner,
	sender_mask,
	sender_merchant,
	sender_terminal,
	sender_service,
	updated_at
FROM P2P_2024
ORDER BY NEWID();



SELECT TOP 6 * FROM InfoP2P;

SELECT COLUMN_NAME, DATA_TYPE, CHARACTER_MAXIMUM_LENGTH  
FROM INFORMATION_SCHEMA.COLUMNS  
WHERE TABLE_NAME = 'InfoP2P';

DELETE FROM P2P_2024
WHERE CAST(created_at as DATE) = '1900-01-01'

SELECT COUNT(*) FROM InfoP2P
